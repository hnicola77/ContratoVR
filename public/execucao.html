<!DOCTYPE html>
<html lang="pt-BR">
<head>
  <meta charset="UTF-8" />
  <title>Execu√ß√£o - ContratosVR</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <link rel="stylesheet" href="/styles.css" />
</head>
<body>

  <div class="top-menu">
    <a href="/index.html">Contratos</a>
    <a href="/empreendimentos.html">Empreendimentos</a>
    <a href="/distribuicao.html">Distribui√ß√£o</a>
    <a class="ativo" href="/execucao.html">Execu√ß√£o</a>
    
    <div style="margin-left: auto;">
      <span style="margin-right: 16px; color: #64748b;">üèóÔ∏è ContratosVR</span>
    </div>
  </div>

  <div class="container">
    
    <div style="margin-bottom: 24px;">
      <h1 style="margin: 0;">‚ö° Controle de Execu√ß√£o</h1>
      <p style="color: #64748b; margin-top: 8px;">Registre a metragem executada por unidade</p>
    </div>

    <!-- Sele√ß√£o de Contrato -->
    <div style="background: white; padding: 24px; border-radius: 16px; box-shadow: 0 2px 8px rgba(0,0,0,0.1); margin-bottom: 24px;">
      <h3 style="margin-top: 0;">1. Selecione o Contrato</h3>
      
      <div>
        <label style="display: block; margin-bottom: 8px; font-weight: 500;">Contrato</label>
        <select id="contratoSelect" onchange="carregarContrato()" style="width: 100%; padding: 12px; border: 2px solid #e2e8f0; border-radius: 8px;">
          <option value="">Selecione um contrato</option>
        </select>
      </div>

      <!-- Info do Contrato -->
      <div id="infoContrato" style="display: none; margin-top: 16px; padding: 16px; background: #f8f9fa; border-radius: 8px;">
        <div style="display: grid; grid-template-columns: repeat(4, 1fr); gap: 16px;">
          <div>
            <small style="color: #64748b;">Empreendimento</small>
            <div id="infoEmpreendimento" style="font-weight: 600;"></div>
          </div>
          <div>
            <small style="color: #64748b;">Metragem Total</small>
            <div id="infoMetragemTotal" style="font-weight: 600;"></div>
          </div>
          <div>
            <small style="color: #64748b;">Metragem Executada</small>
            <div id="infoMetragemExecutada" style="font-weight: 600; color: #10b981;"></div>
          </div>
          <div>
            <small style="color: #64748b;">% Executado</small>
            <div id="infoPercentual" style="font-weight: 600; color: #3b82f6;"></div>
          </div>
        </div>
      </div>
    </div>

    <!-- √Årea de Execu√ß√£o -->
    <div id="areaExecucao" style="display: none;">
      
      <!-- Bot√£o Registrar -->
      <div style="display: flex; justify-content: flex-end; margin-bottom: 24px;">
        <button class="btn-primary" onclick="abrirModal()">
          ‚ûï Registrar Execu√ß√£o
        </button>
      </div>

      <!-- Resumo por Pavimento -->
      <div id="resumoPavimentos" style="display: grid; grid-template-columns: repeat(auto-fill, minmax(250px, 1fr)); gap: 16px; margin-bottom: 24px;">
      </div>

      <!-- Tabela de Execu√ß√µes -->
      <div class="table-container">
        <table>
          <thead>
            <tr>
              <th>Data</th>
              <th>Bloco</th>
              <th>Pavimento</th>
              <th>Unidade</th>
              <th>Tipo</th>
              <th>Contratado (m¬≤)</th>
              <th>Executado (m¬≤)</th>
              <th>% Executado</th>
              <th>Respons√°vel</th>
            </tr>
          </thead>
          <tbody id="tabelaExecucoes">
            <tr>
              <td colspan="9" style="text-align: center; padding: 40px;">
                Selecione um contrato
              </td>
            </tr>
          </tbody>
        </table>
      </div>

    </div>

  </div>

  <!-- Modal de Registro de Execu√ß√£o -->
  <div id="modalExecucao" style="display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.5); z-index: 1000; overflow-y: auto;">
    <div style="background: white; max-width: 600px; margin: 50px auto; border-radius: 16px; padding: 32px;">
      
      <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 24px;">
        <h2 style="margin: 0;">Registrar Execu√ß√£o</h2>
        <button onclick="fecharModal()" style="background: none; border: none; font-size: 24px; cursor: pointer;">√ó</button>
      </div>

      <form id="formExecucao" onsubmit="salvarExecucao(event)">
        
        <div style="margin-bottom: 20px;">
          <label style="display: block; margin-bottom: 8px; font-weight: 500;">
            Unidade *
          </label>
          <select id="unidadeSelect" required style="width: 100%; padding: 12px; border: 2px solid #e2e8f0; border-radius: 8px;">
            <option value="">Selecione a unidade</option>
          </select>
        </div>

        <div id="infoUnidade" style="display: none; margin-bottom: 20px; padding: 12px; background: #f8f9fa; border-radius: 8px;">
          <small style="color: #64748b;">Metragem Contratada:</small>
          <div id="unidadeMetragemContratada" style="font-weight: 600; font-size: 18px;"></div>
        </div>

        <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 16px; margin-bottom: 20px;">
          <div>
            <label style="display: block; margin-bottom: 8px; font-weight: 500;">
              Metragem Executada (m¬≤) *
            </label>
            <input type="number" id="metragen_executada" required min="0" step="0.01" style="width: 100%; padding: 12px; border: 2px solid #e2e8f0; border-radius: 8px;" placeholder="0.00">
          </div>

          <div>
            <label style="display: block; margin-bottom: 8px; font-weight: 500;">
              Data da Medi√ß√£o *
            </label>
            <input type="date" id="data_medicao" required style="width: 100%; padding: 12px; border: 2px solid #e2e8f0; border-radius: 8px;">
          </div>
        </div>

        <div style="margin-bottom: 20px;">
          <label style="display: block; margin-bottom: 8px; font-weight: 500;">
            Respons√°vel
          </label>
          <input type="text" id="responsavel" style="width: 100%; padding: 12px; border: 2px solid #e2e8f0; border-radius: 8px;" placeholder="Nome do respons√°vel">
        </div>

        <div style="margin-bottom: 20px;">
          <label style="display: block; margin-bottom: 8px; font-weight: 500;">
            Observa√ß√µes
          </label>
          <textarea id="observacoes" rows="3" style="width: 100%; padding: 12px; border: 2px solid #e2e8f0; border-radius: 8px;" placeholder="Observa√ß√µes sobre a execu√ß√£o..."></textarea>
        </div>

        <div style="display: flex; gap: 12px;">
          <button type="submit" class="btn-primary" style="flex: 1;">Salvar</button>
          <button type="button" class="btn-secondary" onclick="fecharModal()" style="flex: 1;">Cancelar</button>
        </div>

      </form>

    </div>
  </div>

  <script>
    let contratos = [];
    let contratoSelecionado = null;
    let distribuicoes = [];
    let execucoes = [];

    // ==================== CARREGAR CONTRATOS ====================
    async function carregarContratos() {
      try {
        const response = await fetch('/api/contratos');
        contratos = await response.json();
        
        const select = document.getElementById('contratoSelect');
        select.innerHTML = '<option value="">Selecione um contrato</option>';
        
        contratos.forEach(c => {
          const option = document.createElement('option');
          option.value = c.id;
          option.textContent = `${c.numero_contrato_oerp} - ${c.empreendimento_nome}`;
          select.appendChild(option);
        });
      } catch (error) {
        console.error('Erro:', error);
        alert('Erro ao carregar contratos');
      }
    }

    // ==================== CARREGAR CONTRATO ====================
    async function carregarContrato() {
      const id = document.getElementById('contratoSelect').value;
      if (!id) {
        document.getElementById('infoContrato').style.display = 'none';
        document.getElementById('areaExecucao').style.display = 'none';
        return;
      }
      
      try {
        const response = await fetch('/api/contratos/' + id);
        contratoSelecionado = await response.json();
        
        // Carregar distribui√ß√µes
        const respDist = await fetch('/api/distribuicao/contrato/' + id);
        distribuicoes = await respDist.json();
        
        // Carregar execu√ß√µes
        const respExec = await fetch('/api/execucao/contrato/' + id);
        execucoes = await respExec.json();
        
        // Calcular totais
        const metragemTotal = parseFloat(contratoSelecionado.metragem_total);
        let metragemExecutada = 0;
        
        // Somar execu√ß√µes por unidade (pegar apenas a √∫ltima)
        const execucoesPorUnidade = {};
        execucoes.forEach(ex => {
          if (!execucoesPorUnidade[ex.unidade_id] || 
              new Date(ex.data_medicao) > new Date(execucoesPorUnidade[ex.unidade_id].data_medicao)) {
            execucoesPorUnidade[ex.unidade_id] = ex;
          }
        });
        
        Object.values(execucoesPorUnidade).forEach(ex => {
          metragemExecutada += parseFloat(ex.metragem_executada);
        });
        
        const percentual = metragemTotal > 0 ? ((metragemExecutada / metragemTotal) * 100).toFixed(2) : 0;
        
        // Mostrar info
        document.getElementById('infoContrato').style.display = 'block';
        document.getElementById('infoEmpreendimento').textContent = contratoSelecionado.empreendimento_nome;
        document.getElementById('infoMetragemTotal').textContent = metragemTotal.toFixed(2) + ' m¬≤';
        document.getElementById('infoMetragemExecutada').textContent = metragemExecutada.toFixed(2) + ' m¬≤';
        document.getElementById('infoPercentual').textContent = percentual + '%';
        
        document.getElementById('areaExecucao').style.display = 'block';
        
        renderizarResumoPavimentos();
        renderizarTabela();
        
      } catch (error) {
        console.error('Erro:', error);
        alert('Erro ao carregar contrato');
      }
    }

    // ==================== RENDERIZAR RESUMO POR PAVIMENTO ====================
    function renderizarResumoPavimentos() {
      const container = document.getElementById('resumoPavimentos');
      container.innerHTML = '';
      
      // Agrupar por pavimento
      const porPavimento = {};
      
      distribuicoes.forEach(dist => {
        if (!porPavimento[dist.pavimento]) {
          porPavimento[dist.pavimento] = {
            contratado: 0,
            executado: 0
          };
        }
        porPavimento[dist.pavimento].contratado += parseFloat(dist.metragem_contratada);
      });
      
      execucoes.forEach(ex => {
        if (porPavimento[ex.pavimento]) {
          porPavimento[ex.pavimento].executado += parseFloat(ex.metragem_executada);
        }
      });
      
      // Renderizar cards
      Object.keys(porPavimento).sort((a, b) => a - b).forEach(pav => {
        const dados = porPavimento[pav];
        const percentual = dados.contratado > 0 ? ((dados.executado / dados.contratado) * 100).toFixed(1) : 0;
        
        const card = document.createElement('div');
        card.style.cssText = 'background: white; padding: 20px; border-radius: 12px; box-shadow: 0 2px 8px rgba(0,0,0,0.1);';
        card.innerHTML = `
          <h4 style="margin: 0 0 12px 0;">Pavimento ${pav}</h4>
          <div style="font-size: 24px; font-weight: 700; color: #3b82f6; margin-bottom: 8px;">${percentual}%</div>
          <div style="color: #64748b; font-size: 14px;">
            ${dados.executado.toFixed(2)} / ${dados.contratado.toFixed(2)} m¬≤
          </div>
          <div style="margin-top: 12px; background: #e2e8f0; border-radius: 4px; height: 8px; overflow: hidden;">
            <div style="background: linear-gradient(90deg, #3b82f6, #2563eb); height: 100%; width: ${percentual}%;"></div>
          </div>
        `;
        container.appendChild(card);
      });
    }

    // ==================== RENDERIZAR TABELA ====================
    function renderizarTabela() {
      const tbody = document.getElementById('tabelaExecucoes');
      
      if (execucoes.length === 0) {
        tbody.innerHTML = '<tr><td colspan="9" style="text-align:center; padding: 40px;">Nenhuma execu√ß√£o registrada ainda</td></tr>';
        return;
      }
      
      tbody.innerHTML = '';
      
      // Ordenar por data (mais recente primeiro)
      execucoes.sort((a, b) => new Date(b.data_medicao) - new Date(a.data_medicao));
      
      execucoes.forEach(ex => {
        // Buscar metragem contratada
        const dist = distribuicoes.find(d => d.unidade_id === ex.unidade_id);
        const metragem_contratada = dist ? parseFloat(dist.metragem_contratada) : 0;
        const percentual = metragem_contratada > 0 
          ? ((parseFloat(ex.metragem_executada) / metragem_contratada) * 100).toFixed(1) 
          : 0;
        
        const tipoBadge = ex.tipo === 'hall' 
          ? '<span style="background: #f59e0b; color: white; padding: 4px 8px; border-radius: 4px; font-size: 12px;">HALL</span>'
          : '<span style="background: #3b82f6; color: white; padding: 4px 8px; border-radius: 4px; font-size: 12px;">APT</span>';
        
        const tr = document.createElement('tr');
        tr.innerHTML = `
          <td>${new Date(ex.data_medicao).toLocaleDateString('pt-BR')}</td>
          <td>${ex.bloco}</td>
          <td>${ex.pavimento}</td>
          <td><strong>${ex.numero_unidade}</strong></td>
          <td>${tipoBadge}</td>
          <td>${metragem_contratada.toFixed(2)} m¬≤</td>
          <td><strong>${parseFloat(ex.metragem_executada).toFixed(2)} m¬≤</strong></td>
          <td>
            <span style="padding: 4px 8px; border-radius: 4px; background: ${percentual >= 100 ? '#d1fae5' : '#dbeafe'}; color: ${percentual >= 100 ? '#065f46' : '#1e40af'}; font-weight: 600;">
              ${percentual}%
            </span>
          </td>
          <td>${ex.responsavel || '-'}</td>
        `;
        tbody.appendChild(tr);
      });
    }

    // ==================== ABRIR MODAL ====================
    function abrirModal() {
      if (!contratoSelecionado) {
        alert('Selecione um contrato primeiro');
        return;
      }
      
      // Preencher unidades
      const select = document.getElementById('unidadeSelect');
      select.innerHTML = '<option value="">Selecione a unidade</option>';
      
      distribuicoes.forEach(dist => {
        const option = document.createElement('option');
        option.value = dist.unidade_id;
        option.textContent = `${dist.bloco} - Pav ${dist.pavimento} - ${dist.numero_unidade} (${parseFloat(dist.metragem_contratada).toFixed(2)} m¬≤)`;
        option.dataset.metragem = dist.metragem_contratada;
        select.appendChild(option);
      });
      
      // Data padr√£o = hoje
      document.getElementById('data_medicao').valueAsDate = new Date();
      
      document.getElementById('modalExecucao').style.display = 'block';
    }

    function fecharModal() {
      document.getElementById('modalExecucao').style.display = 'none';
      document.getElementById('formExecucao').reset();
      document.getElementById('infoUnidade').style.display = 'none';
    }

    // Mostrar info da unidade ao selecionar
    document.getElementById('unidadeSelect')?.addEventListener('change', function() {
      const selected = this.options[this.selectedIndex];
      if (selected.value) {
        document.getElementById('infoUnidade').style.display = 'block';
        document.getElementById('unidadeMetragemContratada').textContent = 
          parseFloat(selected.dataset.metragem).toFixed(2) + ' m¬≤';
      } else {
        document.getElementById('infoUnidade').style.display = 'none';
      }
    });

    // ==================== SALVAR EXECU√á√ÉO ====================
    async function salvarExecucao(event) {
      event.preventDefault();
      
      const dados = {
        contrato_id: contratoSelecionado.id,
        unidade_id: parseInt(document.getElementById('unidadeSelect').value),
        metragem_executada: parseFloat(document.getElementById('metragem_executada').value),
        data_medicao: document.getElementById('data_medicao').value,
        responsavel: document.getElementById('responsavel').value || null,
        observacoes: document.getElementById('observacoes').value || null
      };
      
      try {
        const response = await fetch('/api/execucao/registrar', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify(dados)
        });
        
        const result = await response.json();
        
        if (response.ok) {
          alert('Execu√ß√£o registrada com sucesso!');
          fecharModal();
          carregarContrato(); // Recarregar dados
        } else {
          alert('Erro: ' + result.error);
        }
      } catch (error) {
        console.error('Erro:', error);
        alert('Erro ao salvar execu√ß√£o');
      }
    }

    // ==================== INICIALIZAR ====================
    document.addEventListener('DOMContentLoaded', () => {
      carregarContratos();
    });
  </script>

</body>
</html>
