<!DOCTYPE html>
<html lang="pt-BR">
<head>
  <meta charset="UTF-8">
  <title>Empreendimentos - ContratosVR</title>
  <link rel="stylesheet" href="/styles.css">
</head>
<body>

<div class="top-menu">
  <a href="/index.html">Contratos</a>
  <a class="ativo" href="/empreendimentos.html">Empreendimentos</a>
  <a href="/distribuicao.html">Distribui√ß√£o</a>
  <a href="/execucao.html">Execu√ß√£o</a>
  <div style="margin-left: auto;">
    <span style="margin-right: 16px; color: #64748b;">üèóÔ∏è ContratosVR</span>
  </div>
</div>

<div class="container">
  
  <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 24px;">
    <h1 style="margin: 0;">üè¢ Empreendimentos</h1>
    <button class="btn-primary" onclick="abrirModal()">‚ûï Novo Empreendimento</button>
  </div>

  <div class="table-container">
    <table>
      <thead>
        <tr>
          <th>Nome</th>
          <th>Blocos</th>
          <th>Total Unidades</th>
          <th>A√ß√µes</th>
        </tr>
      </thead>
      <tbody id="tabelaEmpreendimentos">
        <tr><td colspan="4" style="text-align: center; padding: 40px;">Carregando...</td></tr>
      </tbody>
    </table>
  </div>

</div>

<!-- MODAL -->
<div id="modalEmpreendimento" style="display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.5); z-index: 1000; overflow-y: auto;">
  <div style="background: white; max-width: 700px; margin: 50px auto; border-radius: 16px; padding: 32px;">
    
    <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 24px;">
      <h2 style="margin: 0;">Novo Empreendimento</h2>
      <button onclick="fecharModal()" style="background: none; border: none; font-size: 24px; cursor: pointer;">√ó</button>
    </div>

    <!-- IMPORTANTE: onsubmit no form! -->
    <form onsubmit="salvarEmpreendimento(event); return false;">
      
      <div style="margin-bottom: 20px;">
        <label style="display: block; margin-bottom: 8px; font-weight: 500;">Nome do Empreendimento *</label>
        <input type="text" id="nome" required style="width: 100%; padding: 12px; border: 2px solid #e2e8f0; border-radius: 8px;">
      </div>

      <div style="margin-bottom: 20px;">
        <label style="display: block; margin-bottom: 8px; font-weight: 500;">Observa√ß√µes</label>
        <textarea id="observacoes" rows="2" style="width: 100%; padding: 12px; border: 2px solid #e2e8f0; border-radius: 8px;"></textarea>
      </div>

      <hr style="margin: 24px 0; border: none; border-top: 2px solid #e2e8f0;">

      <h3 style="margin-bottom: 16px;">Blocos do Empreendimento</h3>

      <div id="blocosContainer"></div>

      <button type="button" onclick="adicionarBloco()" class="btn-secondary" style="width: 100%; margin-bottom: 20px;">
        ‚ûï Adicionar Bloco
      </button>

      <div style="display: flex; gap: 12px;">
        <!-- IMPORTANTE: type="submit"! -->
        <button type="submit" class="btn-primary" style="flex: 1;">üíæ SALVAR</button>
        <button type="button" onclick="fecharModal()" class="btn-secondary" style="flex: 1;">Cancelar</button>
      </div>

    </form>

  </div>
</div>

<script>
console.log('üöÄ EMPREENDIMENTOS.HTML CARREGADO - VERS√ÉO SIMPLIFICADA');

let empreendimentos = [];
let blocoCount = 0;

// CARREGAR
async function carregarEmpreendimentos() {
  console.log('üìã Carregando...');
  try {
    const response = await fetch('/api/empreendimentos');
    empreendimentos = await response.json();
    console.log('‚úÖ Carregados:', empreendimentos.length);
    renderizarTabela();
  } catch (error) {
    console.error('‚ùå Erro:', error);
    document.getElementById('tabelaEmpreendimentos').innerHTML = 
      '<tr><td colspan="4" style="text-align:center; color: #ef4444;">Erro ao carregar</td></tr>';
  }
}

// RENDERIZAR
async function renderizarTabela() {
  console.log('üé® Renderizando...');
  const tbody = document.getElementById('tabelaEmpreendimentos');
  
  if (empreendimentos.length === 0) {
    tbody.innerHTML = '<tr><td colspan="4" style="text-align:center; padding: 40px;">Nenhum empreendimento</td></tr>';
    return;
  }
  
  tbody.innerHTML = '';
  
  for (const emp of empreendimentos) {
    const respBlocos = await fetch('/api/blocos/empreendimento/' + emp.id);
    const blocos = await respBlocos.json();
    
    let totalUnidades = 0;
    blocos.forEach(b => {
      totalUnidades += b.quantidade_pavimentos * 
        (b.quantidade_apartamentos_por_pavimento + (b.existem_halls ? b.quantidade_halls_por_pavimento : 0));
    });
    
    const tr = document.createElement('tr');
    tr.innerHTML = `
      <td><strong>${emp.nome}</strong></td>
      <td>${blocos.length} bloco(s)</td>
      <td><strong>${totalUnidades}</strong></td>
      <td>
        <button class="btn-small" onclick="gerarUnidades(${emp.id})">üèóÔ∏è</button>
        <button class="btn-small" onclick="verUnidades(${emp.id})">üëÅÔ∏è</button>
        <button class="btn-small" onclick="deletarEmpreendimento(${emp.id})">üóëÔ∏è</button>
      </td>
    `;
    tbody.appendChild(tr);
  }
  
  console.log('‚úÖ Tabela OK');
}

// MODAL
function abrirModal() {
  console.log('üìÇ Abrindo modal...');
  document.getElementById('modalEmpreendimento').style.display = 'block';
  document.getElementById('blocosContainer').innerHTML = '';
  blocoCount = 0;
  adicionarBloco();
}

function fecharModal() {
  console.log('üìÅ Fechando modal...');
  document.getElementById('modalEmpreendimento').style.display = 'none';
  document.getElementById('nome').value = '';
  document.getElementById('observacoes').value = '';
  document.getElementById('blocosContainer').innerHTML = '';
  blocoCount = 0;
}

// ADICIONAR BLOCO
function adicionarBloco() {
  blocoCount++;
  console.log('‚ûï Adicionando bloco', blocoCount);
  
  const container = document.getElementById('blocosContainer');
  
  if (!container) {
    console.error('‚ùå Container de blocos n√£o encontrado!');
    return;
  }
  
  const blocoDiv = document.createElement('div');
  blocoDiv.id = 'bloco_' + blocoCount;
  blocoDiv.style.cssText = 'background: #f8f9fa; padding: 16px; border-radius: 8px; margin-bottom: 16px;';
  
  blocoDiv.innerHTML = `
    <div style="display: flex; justify-content: space-between; margin-bottom: 12px;">
      <h4 style="margin: 0;">Bloco ${blocoCount}</h4>
      <button type="button" onclick="removerBloco(${blocoCount})" style="background: #ef4444; color: white; border: none; padding: 4px 12px; border-radius: 4px; cursor: pointer;">Remover</button>
    </div>
    
    <div style="display: grid; grid-template-columns: 2fr 1fr; gap: 12px; margin-bottom: 12px;">
      <div>
        <label style="display: block; margin-bottom: 4px; font-weight: 500; font-size: 14px;">Nome *</label>
        <input type="text" id="bloco_nome_${blocoCount}" required value="Bloco ${String.fromCharCode(64 + blocoCount)}" style="width: 100%; padding: 8px; border: 2px solid #e2e8f0; border-radius: 4px;">
      </div>
      <div>
        <label style="display: block; margin-bottom: 4px; font-weight: 500; font-size: 14px;">Pavimentos *</label>
        <input type="number" id="bloco_pav_${blocoCount}" required min="1" value="10" style="width: 100%; padding: 8px; border: 2px solid #e2e8f0; border-radius: 4px;">
      </div>
    </div>
    
    <div style="display: grid; grid-template-columns: 1fr 1fr 1fr; gap: 12px;">
      <div>
        <label style="display: block; margin-bottom: 4px; font-weight: 500; font-size: 14px;">Aptos/Pav *</label>
        <input type="number" id="bloco_aptos_${blocoCount}" required min="1" value="4" style="width: 100%; padding: 8px; border: 2px solid #e2e8f0; border-radius: 4px;">
      </div>
      <div>
        <label style="display: block; margin-bottom: 4px; font-weight: 500; font-size: 14px;">Tem Halls?</label>
        <select id="bloco_halls_${blocoCount}" onchange="toggleHalls(${blocoCount})" style="width: 100%; padding: 8px; border: 2px solid #e2e8f0; border-radius: 4px;">
          <option value="0">N√£o</option>
          <option value="1">Sim</option>
        </select>
      </div>
      <div>
        <label style="display: block; margin-bottom: 4px; font-weight: 500; font-size: 14px;">Halls/Pav</label>
        <input type="number" id="bloco_qtd_halls_${blocoCount}" min="0" value="1" disabled style="width: 100%; padding: 8px; border: 2px solid #e2e8f0; border-radius: 4px; background: #e2e8f0;">
      </div>
    </div>
  `;
  
  container.appendChild(blocoDiv);
  console.log('‚úÖ Bloco', blocoCount, 'adicionado. Total no DOM:', container.children.length);
}

function removerBloco(id) {
  console.log('üóëÔ∏è Removendo', id);
  const el = document.getElementById('bloco_' + id);
  if (el) el.remove();
}

function toggleHalls(id) {
  const temHalls = document.getElementById('bloco_halls_' + id).value === '1';
  const input = document.getElementById('bloco_qtd_halls_' + id);
  input.disabled = !temHalls;
  input.value = temHalls ? 1 : 0;
}

// ========== SALVAR ==========
async function salvarEmpreendimento(event) {
  event.preventDefault();
  
  console.log('\n‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ');
  console.log('üíæ SALVANDO EMPREENDIMENTO');
  console.log('‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ');
  
  const nome = document.getElementById('nome').value;
  const observacoes = document.getElementById('observacoes').value;
  
  console.log('üìù Nome:', nome);
  console.log('üìù Obs:', observacoes || '(vazio)');
  
  // Coletar blocos
  const blocos = [];
  const container = document.getElementById('blocosContainer');
  const blocosDivs = container.querySelectorAll('[id^="bloco_"]');
  
  console.log('üì¶ Blocos:', blocosDivs.length);
  
  blocosDivs.forEach((blocoDiv, index) => {
    const id = blocoDiv.id.replace('bloco_', '');
    
    // Verificar se todos os campos existem
    const campoNome = document.getElementById('bloco_nome_' + id);
    const campoPav = document.getElementById('bloco_pav_' + id);
    const campoAptos = document.getElementById('bloco_aptos_' + id);
    const campoHalls = document.getElementById('bloco_halls_' + id);
    const campoQtdHalls = document.getElementById('bloco_qtd_halls_' + id);
    
    if (!campoNome || !campoPav || !campoAptos || !campoHalls || !campoQtdHalls) {
      console.error(`‚ùå Campos do bloco ${id} n√£o encontrados!`);
      return; // Pula este bloco
    }
    
    const bloco = {
      nome: campoNome.value,
      quantidade_pavimentos: parseInt(campoPav.value),
      quantidade_apartamentos_por_pavimento: parseInt(campoAptos.value),
      existem_halls: campoHalls.value === '1',
      quantidade_halls_por_pavimento: parseInt(campoQtdHalls.value) || 0
    };
    
    console.log(`   Bloco ${index + 1}:`, bloco);
    blocos.push(bloco);
  });
  
  if (blocos.length === 0) {
    console.error('‚ùå Nenhum bloco v√°lido encontrado!');
    console.log('Blocos na tela:', blocosDivs.length);
    console.log('Blocos coletados:', blocos.length);
    alert('‚ùå Erro: Nenhum bloco v√°lido! Verifique se preencheu todos os campos.');
    return;
  }
  
  const dados = { nome, observacoes, blocos };
  
  console.log('\nüì§ Enviando POST /api/empreendimentos');
  console.log('Dados:', JSON.stringify(dados, null, 2));
  
  try {
    const response = await fetch('/api/empreendimentos', {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify(dados)
    });
    
    console.log('üì• Status:', response.status);
    
    const result = await response.json();
    console.log('üì¶ Resposta:', result);
    
    if (response.ok) {
      console.log('‚úÖ‚úÖ‚úÖ SUCESSO! ID:', result.id);
      console.log('‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ\n');
      
      alert('‚úÖ Empreendimento criado! ID: ' + result.id);
      fecharModal();
      carregarEmpreendimentos();
    } else {
      console.error('‚ùå ERRO:', result.error);
      console.log('‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ\n');
      alert('‚ùå Erro: ' + result.error);
    }
  } catch (error) {
    console.error('‚ùå EXCE√á√ÉO:', error);
    console.log('‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ\n');
    alert('‚ùå Erro: ' + error.message);
  }
}

// OUTRAS FUN√á√ïES
async function gerarUnidades(empId) {
  if (!confirm('Gerar unidades?')) return;
  try {
    const response = await fetch('/api/unidades/criar-automatico', {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify({ empreendimento_id: empId })
    });
    const result = await response.json();
    if (response.ok) {
      alert(result.message);
    } else {
      alert('Erro: ' + result.error);
    }
  } catch (error) {
    alert('Erro');
  }
}

async function verUnidades(empId) {
  try {
    const response = await fetch('/api/unidades/empreendimento/' + empId);
    const unidades = await response.json();
    if (unidades.length === 0) {
      alert('Nenhuma unidade. Clique em üèóÔ∏è');
      return;
    }
    let texto = 'Unidades:\n\n';
    unidades.forEach(u => {
      texto += `${u.bloco_nome} - Pav ${u.pavimento} - ${u.numero_unidade}\n`;
    });
    alert(texto);
  } catch (error) {
    alert('Erro');
  }
}

async function deletarEmpreendimento(id) {
  if (!confirm('Deletar?')) return;
  try {
    const response = await fetch('/api/empreendimentos/' + id, { method: 'DELETE' });
    if (response.ok) {
      alert('Deletado!');
      carregarEmpreendimentos();
    } else {
      const result = await response.json();
      alert('Erro: ' + result.error);
    }
  } catch (error) {
    alert('Erro');
  }
}

// INICIALIZAR
window.addEventListener('DOMContentLoaded', () => {
  console.log('‚úÖ DOM pronto');
  carregarEmpreendimentos();
});
</script>

</body>
</html>
