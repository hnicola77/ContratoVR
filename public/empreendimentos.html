<!DOCTYPE html>
<html lang="pt-BR">
<head>
  <meta charset="UTF-8" />
  <title>Empreendimentos - ContratosVR</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <link rel="stylesheet" href="/styles.css" />
</head>
<body>

  <div class="top-menu">
    <a href="/index.html">Contratos</a>
    <a class="ativo" href="/empreendimentos.html">Empreendimentos</a>
    <a href="/distribuicao.html">Distribui√ß√£o</a>
    <a href="/execucao.html">Execu√ß√£o</a>
    
    <div style="margin-left: auto;">
      <span style="margin-right: 16px; color: #64748b;">üèóÔ∏è ContratosVR</span>
    </div>
  </div>

  <div class="container">
    
    <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 24px;">
      <h1 style="margin: 0;">üè¢ Empreendimentos</h1>
      <button class="btn-primary" onclick="abrirModal()">
        ‚ûï Novo Empreendimento
      </button>
    </div>

    <!-- Tabela de Empreendimentos -->
    <div class="table-container">
      <table>
        <thead>
          <tr>
            <th>Nome</th>
            <th>Blocos</th>
            <th>Total Unidades</th>
            <th>A√ß√µes</th>
          </tr>
        </thead>
        <tbody id="tabelaEmpreendimentos">
          <tr>
            <td colspan="4" style="text-align: center; padding: 40px;">
              Carregando empreendimentos...
            </td>
          </tr>
        </tbody>
      </table>
    </div>

  </div>

  <!-- Modal de Cadastro -->
  <div id="modalEmpreendimento" style="display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.5); z-index: 1000; overflow-y: auto;">
    <div style="background: white; max-width: 700px; margin: 50px auto; border-radius: 16px; padding: 32px;">
      
      <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 24px;">
        <h2 style="margin: 0;">Novo Empreendimento</h2>
        <button onclick="fecharModal()" style="background: none; border: none; font-size: 24px; cursor: pointer;">√ó</button>
      </div>

      <form id="formEmpreendimento" onsubmit="salvarEmpreendimento(event)">
        
        <div style="margin-bottom: 20px;">
          <label style="display: block; margin-bottom: 8px; font-weight: 500;">
            Nome do Empreendimento *
          </label>
          <input type="text" id="nome" required style="width: 100%; padding: 12px; border: 2px solid #e2e8f0; border-radius: 8px;" placeholder="Ex: Residencial Vista Verde">
        </div>

        <div style="margin-bottom: 20px;">
          <label style="display: block; margin-bottom: 8px; font-weight: 500;">
            Observa√ß√µes
          </label>
          <textarea id="observacoes" rows="2" style="width: 100%; padding: 12px; border: 2px solid #e2e8f0; border-radius: 8px;" placeholder="Informa√ß√µes adicionais..."></textarea>
        </div>

        <hr style="margin: 24px 0; border: none; border-top: 2px solid #e2e8f0;">

        <h3 style="margin-bottom: 16px;">Blocos do Empreendimento</h3>
        <p style="color: #64748b; margin-bottom: 16px; font-size: 14px;">
          Cada bloco pode ter configura√ß√µes diferentes de pavimentos e apartamentos.
        </p>

        <div id="blocosContainer"></div>

        <button type="button" class="btn-secondary" onclick="adicionarBloco()" style="width: 100%; margin-bottom: 20px;">
          ‚ûï Adicionar Bloco
        </button>

        <div style="display: flex; gap: 12px;">
          <button type="submit" class="btn-primary" style="flex: 1;">Salvar</button>
          <button type="button" class="btn-secondary" onclick="fecharModal()" style="flex: 1;">Cancelar</button>
        </div>

      </form>

    </div>
  </div>

  <script>
    let empreendimentos = [];
    let blocoCount = 0;

    // ==================== CARREGAR EMPREENDIMENTOS ====================
    async function carregarEmpreendimentos() {
      try {
        const response = await fetch('/api/empreendimentos');
        if (!response.ok) throw new Error('Erro ao carregar');
        
        empreendimentos = await response.json();
        renderizarTabela();
      } catch (error) {
        console.error('Erro:', error);
        document.getElementById('tabelaEmpreendimentos').innerHTML = 
          '<tr><td colspan="4" style="text-align:center; color: #ef4444;">Erro ao carregar empreendimentos</td></tr>';
      }
    }

    // ==================== RENDERIZAR TABELA ====================
    async function renderizarTabela() {
      const tbody = document.getElementById('tabelaEmpreendimentos');
      
      if (empreendimentos.length === 0) {
        tbody.innerHTML = '<tr><td colspan="4" style="text-align:center; padding: 40px;">Nenhum empreendimento cadastrado</td></tr>';
        return;
      }
      
      tbody.innerHTML = '';
      
      for (const emp of empreendimentos) {
        // Buscar blocos
        const respBlocos = await fetch('/api/blocos/empreendimento/' + emp.id);
        const blocos = await respBlocos.json();
        
        // Calcular total de unidades
        let totalUnidades = 0;
        blocos.forEach(b => {
          totalUnidades += b.quantidade_pavimentos * 
            (b.quantidade_apartamentos_por_pavimento + (b.existem_halls ? b.quantidade_halls_por_pavimento : 0));
        });
        
        const tr = document.createElement('tr');
        tr.innerHTML = `
          <td><strong>${emp.nome}</strong></td>
          <td>${blocos.length} bloco(s)</td>
          <td><strong>${totalUnidades}</strong></td>
          <td>
            <button class="btn-small" onclick="gerarUnidades(${emp.id})" title="Gerar unidades">üèóÔ∏è</button>
            <button class="btn-small" onclick="verUnidades(${emp.id})" title="Ver unidades">üëÅÔ∏è</button>
            <button class="btn-small" onclick="verDetalhes(${emp.id})" title="Ver detalhes">üìã</button>
            <button class="btn-small" onclick="deletarEmpreendimento(${emp.id})" title="Deletar">üóëÔ∏è</button>
          </td>
        `;
        tbody.appendChild(tr);
      }
    }

    // ==================== ABRIR/FECHAR MODAL ====================
    function abrirModal() {
      document.getElementById('modalEmpreendimento').style.display = 'block';
      document.getElementById('blocosContainer').innerHTML = '';
      blocoCount = 0;
      adicionarBloco(); // Adiciona o primeiro bloco automaticamente
    }

    function fecharModal() {
      document.getElementById('modalEmpreendimento').style.display = 'none';
      document.getElementById('formEmpreendimento').reset();
      document.getElementById('blocosContainer').innerHTML = '';
      blocoCount = 0;
    }

    // ==================== ADICIONAR BLOCO ====================
    function adicionarBloco() {
      blocoCount++;
      const container = document.getElementById('blocosContainer');
      
      const blocoDiv = document.createElement('div');
      blocoDiv.id = 'bloco_' + blocoCount;
      blocoDiv.style.cssText = 'background: #f8f9fa; padding: 16px; border-radius: 8px; margin-bottom: 16px; position: relative;';
      
      blocoDiv.innerHTML = `
        <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 12px;">
          <h4 style="margin: 0;">Bloco ${blocoCount}</h4>
          <button type="button" onclick="removerBloco(${blocoCount})" style="background: #ef4444; color: white; border: none; padding: 4px 12px; border-radius: 4px; cursor: pointer;">
            Remover
          </button>
        </div>
        
        <div style="display: grid; grid-template-columns: 2fr 1fr; gap: 12px; margin-bottom: 12px;">
          <div>
            <label style="display: block; margin-bottom: 4px; font-weight: 500; font-size: 14px;">Nome do Bloco *</label>
            <input type="text" id="bloco_nome_${blocoCount}" required value="Bloco ${String.fromCharCode(64 + blocoCount)}" style="width: 100%; padding: 8px; border: 2px solid #e2e8f0; border-radius: 4px;">
          </div>
          
          <div>
            <label style="display: block; margin-bottom: 4px; font-weight: 500; font-size: 14px;">Pavimentos *</label>
            <input type="number" id="bloco_pav_${blocoCount}" required min="1" value="10" style="width: 100%; padding: 8px; border: 2px solid #e2e8f0; border-radius: 4px;">
          </div>
        </div>
        
        <div style="display: grid; grid-template-columns: 1fr 1fr 1fr; gap: 12px; margin-bottom: 12px;">
          <div>
            <label style="display: block; margin-bottom: 4px; font-weight: 500; font-size: 14px;">Aptos/Pav *</label>
            <input type="number" id="bloco_aptos_${blocoCount}" required min="1" value="4" style="width: 100%; padding: 8px; border: 2px solid #e2e8f0; border-radius: 4px;">
          </div>
          
          <div>
            <label style="display: block; margin-bottom: 4px; font-weight: 500; font-size: 14px;">Tem Halls?</label>
            <select id="bloco_halls_${blocoCount}" onchange="toggleHallsBloco(${blocoCount})" style="width: 100%; padding: 8px; border: 2px solid #e2e8f0; border-radius: 4px;">
              <option value="0">N√£o</option>
              <option value="1">Sim</option>
            </select>
          </div>
          
          <div>
            <label style="display: block; margin-bottom: 4px; font-weight: 500; font-size: 14px;">Halls/Pav</label>
            <input type="number" id="bloco_qtd_halls_${blocoCount}" min="0" value="1" disabled style="width: 100%; padding: 8px; border: 2px solid #e2e8f0; border-radius: 4px; background: #e2e8f0;">
          </div>
        </div>
      `;
      
      container.appendChild(blocoDiv);
    }

    function removerBloco(id) {
      const blocoDiv = document.getElementById('bloco_' + id);
      if (blocoDiv) {
        blocoDiv.remove();
      }
    }

    function toggleHallsBloco(id) {
      const temHalls = document.getElementById('bloco_halls_' + id).value === '1';
      const inputQtd = document.getElementById('bloco_qtd_halls_' + id);
      inputQtd.disabled = !temHalls;
      if (!temHalls) {
        inputQtd.value = 0;
      } else {
        inputQtd.value = 1;
      }
    }

    // ==================== SALVAR EMPREENDIMENTO ====================
    async function salvarEmpreendimento(event) {
      event.preventDefault();
      
      const nome = document.getElementById('nome').value;
      const observacoes = document.getElementById('observacoes').value;
      
      // Coletar dados dos blocos
      const blocos = [];
      const container = document.getElementById('blocosContainer');
      const blocosDivs = container.querySelectorAll('[id^="bloco_"]');
      
      blocosDivs.forEach(blocoDiv => {
        const id = blocoDiv.id.replace('bloco_', '');
        
        const bloco = {
          nome: document.getElementById('bloco_nome_' + id).value,
          quantidade_pavimentos: parseInt(document.getElementById('bloco_pav_' + id).value),
          quantidade_apartamentos_por_pavimento: parseInt(document.getElementById('bloco_aptos_' + id).value),
          existem_halls: document.getElementById('bloco_halls_' + id).value === '1',
          quantidade_halls_por_pavimento: parseInt(document.getElementById('bloco_qtd_halls_' + id).value) || 0
        };
        
        blocos.push(bloco);
      });
      
      if (blocos.length === 0) {
        alert('Adicione pelo menos um bloco!');
        return;
      }
      
      const dados = { nome, observacoes, blocos };
      
      console.log('Enviando:', JSON.stringify(dados, null, 2));
      
      try {
        const response = await fetch('/api/empreendimentos', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify(dados)
        });
        
        const result = await response.json();
        
        if (response.ok) {
          alert('Empreendimento criado com sucesso!');
          fecharModal();
          carregarEmpreendimentos();
        } else {
          alert('Erro: ' + result.error);
        }
      } catch (error) {
        console.error('Erro:', error);
        alert('Erro ao salvar empreendimento: ' + error.message);
      }
    }

    // ==================== GERAR UNIDADES ====================
    async function gerarUnidades(empId) {
      if (!confirm('Deseja gerar automaticamente todas as unidades deste empreendimento?')) {
        return;
      }
      
      try {
        const response = await fetch('/api/unidades/criar-automatico', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ empreendimento_id: empId })
        });
        
        const result = await response.json();
        
        if (response.ok) {
          alert(result.message + '\nTotal: ' + result.total + '\nCriadas: ' + result.inserted + '\nDuplicadas: ' + result.duplicated);
        } else {
          alert('Erro: ' + result.error);
        }
      } catch (error) {
        console.error('Erro:', error);
        alert('Erro ao gerar unidades');
      }
    }

    // ==================== VER UNIDADES ====================
    async function verUnidades(empId) {
      try {
        const response = await fetch('/api/unidades/empreendimento/' + empId);
        const unidades = await response.json();
        
        if (unidades.length === 0) {
          alert('Nenhuma unidade cadastrada ainda. Clique em üèóÔ∏è para gerar automaticamente.');
          return;
        }
        
        let texto = 'Unidades cadastradas:\n\n';
        unidades.forEach(u => {
          texto += `${u.bloco_nome} - Pav ${u.pavimento} - ${u.numero_unidade} (${u.tipo})\n`;
        });
        
        alert(texto);
      } catch (error) {
        console.error('Erro:', error);
        alert('Erro ao carregar unidades');
      }
    }

    // ==================== VER DETALHES ====================
    async function verDetalhes(empId) {
      try {
        const resp = await fetch('/api/empreendimentos/' + empId);
        const emp = await resp.json();
        
        let texto = `EMPREENDIMENTO: ${emp.nome}\n\n`;
        texto += 'BLOCOS:\n';
        
        emp.blocos.forEach(b => {
          texto += `\n${b.nome}:\n`;
          texto += `  - Pavimentos: ${b.quantidade_pavimentos}\n`;
          texto += `  - Aptos/Pav: ${b.quantidade_apartamentos_por_pavimento}\n`;
          texto += `  - Halls: ${b.existem_halls ? 'Sim (' + b.quantidade_halls_por_pavimento + ')' : 'N√£o'}\n`;
        });
        
        if (emp.observacoes) {
          texto += `\nOBS: ${emp.observacoes}`;
        }
        
        alert(texto);
      } catch (error) {
        console.error('Erro:', error);
        alert('Erro ao carregar detalhes');
      }
    }

    // ==================== DELETAR ====================
    async function deletarEmpreendimento(id) {
      if (!confirm('Deseja realmente deletar este empreendimento?')) {
        return;
      }
      
      try {
        const response = await fetch('/api/empreendimentos/' + id, {
          method: 'DELETE'
        });
        
        const result = await response.json();
        
        if (response.ok) {
          alert('Empreendimento deletado com sucesso!');
          carregarEmpreendimentos();
        } else {
          alert('Erro: ' + result.error);
        }
      } catch (error) {
        console.error('Erro:', error);
        alert('Erro ao deletar empreendimento');
      }
    }

    // ==================== INICIALIZAR ====================
    document.addEventListener('DOMContentLoaded', () => {
      carregarEmpreendimentos();
    });
  </script>

</body>
</html>
