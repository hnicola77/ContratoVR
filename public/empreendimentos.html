<!DOCTYPE html>
<html lang="pt-BR">
<head>
  <meta charset="UTF-8">
  <title>Empreendimentos - ContratosVR</title>
  <link rel="stylesheet" href="/styles.css">
</head>
<body>

<div class="top-menu">
  <a href="/index.html">Contratos</a>
  <a class="ativo" href="/empreendimentos.html">Empreendimentos</a>
  <a href="/distribuicao.html">Distribui√ß√£o</a>
  <a href="/execucao.html">Execu√ß√£o</a>
  <div style="margin-left: auto;">
    <span style="margin-right: 16px; color: #64748b;">üèóÔ∏è ContratosVR v4.0</span>
  </div>
</div>

<div class="container">
  
  <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 24px;">
    <h1 style="margin: 0;">üè¢ Empreendimentos</h1>
    <button class="btn-primary" onclick="abrirModalNovo()">‚ûï Novo Empreendimento</button>
  </div>

  <div class="table-container">
    <table>
      <thead>
        <tr>
          <th>Nome</th>
          <th>Blocos</th>
          <th>Total Unidades</th>
          <th>A√ß√µes</th>
        </tr>
      </thead>
      <tbody id="tabelaEmpreendimentos">
        <tr><td colspan="4" style="text-align: center; padding: 40px;">Carregando...</td></tr>
      </tbody>
    </table>
  </div>

</div>

<!-- MODAL CADASTRO/EDI√á√ÉO -->
<div id="modalEmpreendimento" style="display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.5); z-index: 1000; overflow-y: auto;">
  <div style="background: white; max-width: 700px; margin: 50px auto; border-radius: 16px; padding: 32px;">
    
    <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 24px;">
      <h2 style="margin: 0;" id="modalTitulo">Novo Empreendimento</h2>
      <button onclick="fecharModal()" style="background: none; border: none; font-size: 24px; cursor: pointer;">√ó</button>
    </div>

    <form onsubmit="salvarEmpreendimento(event); return false;">
      
      <input type="hidden" id="empreendimento_id">
      
      <div style="margin-bottom: 20px;">
        <label style="display: block; margin-bottom: 8px; font-weight: 500;">Nome do Empreendimento *</label>
        <input type="text" id="nome" required style="width: 100%; padding: 12px; border: 2px solid #e2e8f0; border-radius: 8px;">
      </div>

      <div style="margin-bottom: 20px;">
        <label style="display: block; margin-bottom: 8px; font-weight: 500;">Observa√ß√µes</label>
        <textarea id="observacoes" rows="2" style="width: 100%; padding: 12px; border: 2px solid #e2e8f0; border-radius: 8px;"></textarea>
      </div>

      <hr style="margin: 24px 0; border: none; border-top: 2px solid #e2e8f0;">

      <h3 style="margin-bottom: 16px;">Blocos do Empreendimento</h3>

      <div id="blocosContainer"></div>

      <button type="button" onclick="adicionarBloco()" class="btn-secondary" style="width: 100%; margin-bottom: 20px;">
        ‚ûï Adicionar Bloco
      </button>

      <div style="display: flex; gap: 12px;">
        <button type="submit" class="btn-primary" style="flex: 1;">üíæ Salvar</button>
        <button type="button" onclick="fecharModal()" class="btn-secondary" style="flex: 1;">Cancelar</button>
      </div>

    </form>

  </div>
</div>

<!-- MODAL VISUALIZA√á√ÉO DE UNIDADES -->
<div id="modalUnidades" style="display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.5); z-index: 1000; overflow-y: auto;">
  <div style="background: white; max-width: 1200px; margin: 50px auto; border-radius: 16px; padding: 32px;">
    
    <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 24px;">
      <div>
        <h2 style="margin: 0;" id="unidadesTitulo">Unidades</h2>
        <p style="margin: 4px 0 0 0; color: #64748b;" id="unidadesSubtitulo"></p>
      </div>
      <button onclick="fecharModalUnidades()" style="background: none; border: none; font-size: 24px; cursor: pointer;">√ó</button>
    </div>

    <!-- Filtros -->
    <div style="display: flex; gap: 12px; margin-bottom: 20px; flex-wrap: wrap;">
      <div style="flex: 1; min-width: 200px;">
        <input type="text" id="buscaUnidade" placeholder="üîç Buscar unidade..." style="width: 100%; padding: 10px; border: 2px solid #e2e8f0; border-radius: 8px;" onkeyup="filtrarUnidades()">
      </div>
      <div style="min-width: 150px;">
        <select id="filtroBloco" style="width: 100%; padding: 10px; border: 2px solid #e2e8f0; border-radius: 8px;" onchange="filtrarUnidades()">
          <option value="">Todos os blocos</option>
        </select>
      </div>
      <div style="min-width: 150px;">
        <select id="filtroTipo" style="width: 100%; padding: 10px; border: 2px solid #e2e8f0; border-radius: 8px;" onchange="filtrarUnidades()">
          <option value="">Todos os tipos</option>
          <option value="apartamento">Apartamentos</option>
          <option value="hall">Halls</option>
        </select>
      </div>
      <button onclick="exportarUnidades()" class="btn-secondary">üìä Exportar Excel</button>
    </div>

    <!-- Estat√≠sticas -->
    <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(150px, 1fr)); gap: 12px; margin-bottom: 20px;">
      <div style="background: #f0f9ff; padding: 16px; border-radius: 8px; text-align: center;">
        <div style="font-size: 24px; font-weight: bold; color: #0369a1;" id="statTotal">0</div>
        <div style="font-size: 12px; color: #64748b;">Total</div>
      </div>
      <div style="background: #f0fdf4; padding: 16px; border-radius: 8px; text-align: center;">
        <div style="font-size: 24px; font-weight: bold; color: #16a34a;" id="statAptos">0</div>
        <div style="font-size: 12px; color: #64748b;">Apartamentos</div>
      </div>
      <div style="background: #fef3c7; padding: 16px; border-radius: 8px; text-align: center;">
        <div style="font-size: 24px; font-weight: bold; color: #ca8a04;" id="statHalls">0</div>
        <div style="font-size: 12px; color: #64748b;">Halls</div>
      </div>
      <div style="background: #f3e8ff; padding: 16px; border-radius: 8px; text-align: center;">
        <div style="font-size: 24px; font-weight: bold; color: #9333ea;" id="statBlocos">0</div>
        <div style="font-size: 12px; color: #64748b;">Blocos</div>
      </div>
    </div>

    <!-- Tabela de Unidades -->
    <div class="table-container" style="max-height: 500px; overflow-y: auto;">
      <table>
        <thead style="position: sticky; top: 0; background: white; z-index: 10;">
          <tr>
            <th>Bloco</th>
            <th>Pavimento</th>
            <th>Unidade</th>
            <th>Tipo</th>
            <th>Tipologia</th>
            <th>√Årea (m¬≤)</th>
            <th>A√ß√µes</th>
          </tr>
        </thead>
        <tbody id="tabelaUnidades">
          <tr><td colspan="7" style="text-align: center; padding: 40px;">Carregando...</td></tr>
        </tbody>
      </table>
    </div>

    <div style="margin-top: 20px; text-align: right;">
      <button onclick="fecharModalUnidades()" class="btn-secondary">Fechar</button>
    </div>

  </div>
</div>

<script>
console.log('üöÄ ContratosVR v4.0 - EDI√á√ÉO E VISUALIZA√á√ÉO AVAN√áADA');

let empreendimentos = [];
let unidadesCache = [];
let blocoCount = 0;
let modoEdicao = false;
let empreendimentoAtualId = null;

// ==================== CARREGAR ====================
async function carregarEmpreendimentos() {
  console.log('üìã Carregando empreendimentos...');
  try {
    const response = await fetch('/api/empreendimentos');
    empreendimentos = await response.json();
    console.log('‚úÖ Carregados:', empreendimentos.length);
    renderizarTabela();
  } catch (error) {
    console.error('‚ùå Erro:', error);
    document.getElementById('tabelaEmpreendimentos').innerHTML = 
      '<tr><td colspan="4" style="text-align:center; color: #ef4444;">Erro ao carregar</td></tr>';
  }
}

async function renderizarTabela() {
  console.log('üé® Renderizando tabela...');
  const tbody = document.getElementById('tabelaEmpreendimentos');
  
  if (empreendimentos.length === 0) {
    tbody.innerHTML = '<tr><td colspan="4" style="text-align:center; padding: 40px;">Nenhum empreendimento cadastrado</td></tr>';
    return;
  }
  
  tbody.innerHTML = '';
  
  for (const emp of empreendimentos) {
    const respBlocos = await fetch('/api/blocos/empreendimento/' + emp.id);
    const blocos = await respBlocos.json();
    
    const respUnidades = await fetch('/api/unidades/empreendimento/' + emp.id);
    const unidades = await respUnidades.json();
    
    const tr = document.createElement('tr');
    tr.innerHTML = `
      <td><strong>${emp.nome}</strong></td>
      <td>${blocos.length} bloco(s)</td>
      <td><strong>${unidades.length}</strong></td>
      <td>
        <button class="btn-small" onclick="editarEmpreendimento(${emp.id})" title="Editar">‚úèÔ∏è</button>
        <button class="btn-small" onclick="gerarUnidades(${emp.id})" title="Gerar unidades">üèóÔ∏è</button>
        <button class="btn-small" onclick="verUnidadesCompleto(${emp.id})" title="Ver unidades">üëÅÔ∏è</button>
        <button class="btn-small" onclick="deletarEmpreendimento(${emp.id})" title="Deletar">üóëÔ∏è</button>
      </td>
    `;
    tbody.appendChild(tr);
  }
  
  console.log('‚úÖ Tabela renderizada');
}

// ==================== MODAL NOVO ====================
function abrirModalNovo() {
  console.log('üìÇ Abrindo modal NOVO...');
  modoEdicao = false;
  empreendimentoAtualId = null;
  document.getElementById('modalTitulo').textContent = 'Novo Empreendimento';
  document.getElementById('empreendimento_id').value = '';
  document.getElementById('nome').value = '';
  document.getElementById('observacoes').value = '';
  document.getElementById('blocosContainer').innerHTML = '';
  blocoCount = 0;
  adicionarBloco();
  document.getElementById('modalEmpreendimento').style.display = 'block';
}

// ==================== EDITAR EMPREENDIMENTO ====================
async function editarEmpreendimento(id) {
  console.log('‚úèÔ∏è Editando empreendimento:', id);
  modoEdicao = true;
  empreendimentoAtualId = id;
  
  try {
    const response = await fetch('/api/empreendimentos/' + id);
    const emp = await response.json();
    
    document.getElementById('modalTitulo').textContent = 'Editar Empreendimento';
    document.getElementById('empreendimento_id').value = emp.id;
    document.getElementById('nome').value = emp.nome;
    document.getElementById('observacoes').value = emp.observacoes || '';
    
    // Carregar blocos
    document.getElementById('blocosContainer').innerHTML = '';
    blocoCount = 0;
    
    if (emp.blocos && emp.blocos.length > 0) {
      emp.blocos.forEach(bloco => {
        blocoCount++;
        const container = document.getElementById('blocosContainer');
        const blocoDiv = document.createElement('div');
        blocoDiv.id = 'bloco_' + blocoCount;
        blocoDiv.style.cssText = 'background: #f8f9fa; padding: 16px; border-radius: 8px; margin-bottom: 16px;';
        
        blocoDiv.innerHTML = `
          <div style="display: flex; justify-content: space-between; margin-bottom: 12px;">
            <h4 style="margin: 0;">Bloco ${blocoCount}</h4>
            <button type="button" onclick="removerBloco(${blocoCount})" style="background: #ef4444; color: white; border: none; padding: 4px 12px; border-radius: 4px; cursor: pointer;">Remover</button>
          </div>
          
          <input type="hidden" id="bloco_id_${blocoCount}" value="${bloco.id || ''}">
          
          <div style="display: grid; grid-template-columns: 2fr 1fr; gap: 12px; margin-bottom: 12px;">
            <div>
              <label style="display: block; margin-bottom: 4px; font-weight: 500; font-size: 14px;">Nome *</label>
              <input type="text" id="bloco_nome_${blocoCount}" required value="${bloco.nome}" style="width: 100%; padding: 8px; border: 2px solid #e2e8f0; border-radius: 4px;">
            </div>
            <div>
              <label style="display: block; margin-bottom: 4px; font-weight: 500; font-size: 14px;">Pavimentos *</label>
              <input type="number" id="bloco_pav_${blocoCount}" required min="1" value="${bloco.quantidade_pavimentos}" style="width: 100%; padding: 8px; border: 2px solid #e2e8f0; border-radius: 4px;">
            </div>
          </div>
          
          <div style="display: grid; grid-template-columns: 1fr 1fr 1fr; gap: 12px;">
            <div>
              <label style="display: block; margin-bottom: 4px; font-weight: 500; font-size: 14px;">Aptos/Pav *</label>
              <input type="number" id="bloco_aptos_${blocoCount}" required min="1" value="${bloco.quantidade_apartamentos_por_pavimento}" style="width: 100%; padding: 8px; border: 2px solid #e2e8f0; border-radius: 4px;">
            </div>
            <div>
              <label style="display: block; margin-bottom: 4px; font-weight: 500; font-size: 14px;">Tem Halls?</label>
              <select id="bloco_halls_${blocoCount}" onchange="toggleHalls(${blocoCount})" style="width: 100%; padding: 8px; border: 2px solid #e2e8f0; border-radius: 4px;">
                <option value="0" ${!bloco.existem_halls ? 'selected' : ''}>N√£o</option>
                <option value="1" ${bloco.existem_halls ? 'selected' : ''}>Sim</option>
              </select>
            </div>
            <div>
              <label style="display: block; margin-bottom: 4px; font-weight: 500; font-size: 14px;">Halls/Pav</label>
              <input type="number" id="bloco_qtd_halls_${blocoCount}" min="0" value="${bloco.quantidade_halls_por_pavimento || 0}" ${!bloco.existem_halls ? 'disabled' : ''} style="width: 100%; padding: 8px; border: 2px solid #e2e8f0; border-radius: 4px; ${!bloco.existem_halls ? 'background: #e2e8f0;' : ''}">
            </div>
          </div>
        `;
        
        container.appendChild(blocoDiv);
      });
    } else {
      adicionarBloco();
    }
    
    document.getElementById('modalEmpreendimento').style.display = 'block';
  } catch (error) {
    console.error('‚ùå Erro ao carregar empreendimento:', error);
    alert('Erro ao carregar empreendimento para edi√ß√£o');
  }
}

function fecharModal() {
  console.log('üìÅ Fechando modal...');
  document.getElementById('modalEmpreendimento').style.display = 'none';
  modoEdicao = false;
  empreendimentoAtualId = null;
}

// ==================== ADICIONAR BLOCO ====================
function adicionarBloco() {
  blocoCount++;
  console.log('‚ûï Adicionando bloco', blocoCount);
  
  const container = document.getElementById('blocosContainer');
  if (!container) {
    console.error('‚ùå Container n√£o encontrado!');
    return;
  }
  
  const blocoDiv = document.createElement('div');
  blocoDiv.id = 'bloco_' + blocoCount;
  blocoDiv.style.cssText = 'background: #f8f9fa; padding: 16px; border-radius: 8px; margin-bottom: 16px;';
  
  blocoDiv.innerHTML = `
    <div style="display: flex; justify-content: space-between; margin-bottom: 12px;">
      <h4 style="margin: 0;">Bloco ${blocoCount}</h4>
      <button type="button" onclick="removerBloco(${blocoCount})" style="background: #ef4444; color: white; border: none; padding: 4px 12px; border-radius: 4px; cursor: pointer;">Remover</button>
    </div>
    
    <input type="hidden" id="bloco_id_${blocoCount}" value="">
    
    <div style="display: grid; grid-template-columns: 2fr 1fr; gap: 12px; margin-bottom: 12px;">
      <div>
        <label style="display: block; margin-bottom: 4px; font-weight: 500; font-size: 14px;">Nome *</label>
        <input type="text" id="bloco_nome_${blocoCount}" required value="Bloco ${String.fromCharCode(64 + blocoCount)}" style="width: 100%; padding: 8px; border: 2px solid #e2e8f0; border-radius: 4px;">
      </div>
      <div>
        <label style="display: block; margin-bottom: 4px; font-weight: 500; font-size: 14px;">Pavimentos *</label>
        <input type="number" id="bloco_pav_${blocoCount}" required min="1" value="10" style="width: 100%; padding: 8px; border: 2px solid #e2e8f0; border-radius: 4px;">
      </div>
    </div>
    
    <div style="display: grid; grid-template-columns: 1fr 1fr 1fr; gap: 12px;">
      <div>
        <label style="display: block; margin-bottom: 4px; font-weight: 500; font-size: 14px;">Aptos/Pav *</label>
        <input type="number" id="bloco_aptos_${blocoCount}" required min="1" value="4" style="width: 100%; padding: 8px; border: 2px solid #e2e8f0; border-radius: 4px;">
      </div>
      <div>
        <label style="display: block; margin-bottom: 4px; font-weight: 500; font-size: 14px;">Tem Halls?</label>
        <select id="bloco_halls_${blocoCount}" onchange="toggleHalls(${blocoCount})" style="width: 100%; padding: 8px; border: 2px solid #e2e8f0; border-radius: 4px;">
          <option value="0">N√£o</option>
          <option value="1">Sim</option>
        </select>
      </div>
      <div>
        <label style="display: block; margin-bottom: 4px; font-weight: 500; font-size: 14px;">Halls/Pav</label>
        <input type="number" id="bloco_qtd_halls_${blocoCount}" min="0" value="1" disabled style="width: 100%; padding: 8px; border: 2px solid #e2e8f0; border-radius: 4px; background: #e2e8f0;">
      </div>
    </div>
  `;
  
  container.appendChild(blocoDiv);
  console.log('‚úÖ Bloco adicionado. Total:', container.children.length);
}

function removerBloco(id) {
  console.log('üóëÔ∏è Removendo bloco', id);
  const el = document.getElementById('bloco_' + id);
  if (el) el.remove();
}

function toggleHalls(id) {
  const temHalls = document.getElementById('bloco_halls_' + id).value === '1';
  const input = document.getElementById('bloco_qtd_halls_' + id);
  input.disabled = !temHalls;
  input.value = temHalls ? 1 : 0;
  if (temHalls) {
    input.style.background = 'white';
  } else {
    input.style.background = '#e2e8f0';
  }
}

// ==================== SALVAR ====================
async function salvarEmpreendimento(event) {
  event.preventDefault();
  
  console.log('\n‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ');
  console.log(modoEdicao ? '‚úèÔ∏è EDITANDO EMPREENDIMENTO' : 'üíæ SALVANDO EMPREENDIMENTO');
  console.log('‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ');
  
  const id = document.getElementById('empreendimento_id').value;
  const nome = document.getElementById('nome').value;
  const observacoes = document.getElementById('observacoes').value;
  
  console.log('ID:', id || '(novo)');
  console.log('Nome:', nome);
  
  // Coletar blocos
  const blocos = [];
  const container = document.getElementById('blocosContainer');
  const blocosDivs = container.querySelectorAll('[id^="bloco_"]');
  
  blocosDivs.forEach((blocoDiv, index) => {
    const blocoId = blocoDiv.id.replace('bloco_', '');
    
    const campoNome = document.getElementById('bloco_nome_' + blocoId);
    const campoPav = document.getElementById('bloco_pav_' + blocoId);
    const campoAptos = document.getElementById('bloco_aptos_' + blocoId);
    const campoHalls = document.getElementById('bloco_halls_' + blocoId);
    const campoQtdHalls = document.getElementById('bloco_qtd_halls_' + blocoId);
    
    if (!campoNome || !campoPav || !campoAptos || !campoHalls || !campoQtdHalls) {
      console.error(`‚ùå Campos do bloco ${blocoId} n√£o encontrados!`);
      return;
    }
    
    const bloco = {
      nome: campoNome.value,
      quantidade_pavimentos: parseInt(campoPav.value),
      quantidade_apartamentos_por_pavimento: parseInt(campoAptos.value),
      existem_halls: campoHalls.value === '1',
      quantidade_halls_por_pavimento: parseInt(campoQtdHalls.value) || 0
    };
    
    console.log(`   Bloco ${index + 1}:`, bloco.nome);
    blocos.push(bloco);
  });
  
  if (blocos.length === 0) {
    console.error('‚ùå Nenhum bloco v√°lido!');
    alert('‚ùå Adicione pelo menos um bloco!');
    return;
  }
  
  const dados = { nome, observacoes, blocos };
  
  try {
    let response;
    
    if (modoEdicao && id) {
      // EDITAR
      console.log('üì§ PUT /api/empreendimentos/' + id);
      response = await fetch('/api/empreendimentos/' + id, {
        method: 'PUT',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify(dados)
      });
    } else {
      // CRIAR
      console.log('üì§ POST /api/empreendimentos');
      response = await fetch('/api/empreendimentos', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify(dados)
      });
    }
    
    const result = await response.json();
    
    if (response.ok) {
      console.log('‚úÖ‚úÖ‚úÖ SUCESSO!');
      console.log('‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ\n');
      
      alert(modoEdicao ? '‚úÖ Empreendimento atualizado!' : '‚úÖ Empreendimento criado! ID: ' + result.id);
      fecharModal();
      carregarEmpreendimentos();
    } else {
      console.error('‚ùå ERRO:', result.error);
      alert('‚ùå Erro: ' + result.error);
    }
  } catch (error) {
    console.error('‚ùå EXCE√á√ÉO:', error);
    alert('‚ùå Erro: ' + error.message);
  }
}

// ==================== VER UNIDADES COMPLETO ====================
async function verUnidadesCompleto(empId) {
  console.log('üëÅÔ∏è Visualiza√ß√£o completa de unidades:', empId);
  
  try {
    // Buscar empreendimento
    const respEmp = await fetch('/api/empreendimentos/' + empId);
    const emp = await respEmp.json();
    
    // Buscar unidades
    const respUnidades = await fetch('/api/unidades/empreendimento/' + empId);
    const unidades = await respUnidades.json();
    
    unidadesCache = unidades;
    
    document.getElementById('unidadesTitulo').textContent = emp.nome;
    document.getElementById('unidadesSubtitulo').textContent = `${unidades.length} unidades cadastradas`;
    
    // Preencher filtro de blocos
    const blocos = [...new Set(unidades.map(u => u.bloco_nome))];
    const selectBloco = document.getElementById('filtroBloco');
    selectBloco.innerHTML = '<option value="">Todos os blocos</option>';
    blocos.forEach(bloco => {
      selectBloco.innerHTML += `<option value="${bloco}">${bloco}</option>`;
    });
    
    // Atualizar estat√≠sticas
    atualizarEstatisticas(unidades);
    
    // Renderizar tabela
    renderizarTabelaUnidades(unidades);
    
    document.getElementById('modalUnidades').style.display = 'block';
  } catch (error) {
    console.error('‚ùå Erro:', error);
    alert('Erro ao carregar unidades');
  }
}

function atualizarEstatisticas(unidades) {
  const total = unidades.length;
  const aptos = unidades.filter(u => u.tipo === 'apartamento').length;
  const halls = unidades.filter(u => u.tipo === 'hall').length;
  const blocos = [...new Set(unidades.map(u => u.bloco_nome))].length;
  
  document.getElementById('statTotal').textContent = total;
  document.getElementById('statAptos').textContent = aptos;
  document.getElementById('statHalls').textContent = halls;
  document.getElementById('statBlocos').textContent = blocos;
}

function renderizarTabelaUnidades(unidades) {
  const tbody = document.getElementById('tabelaUnidades');
  
  if (unidades.length === 0) {
    tbody.innerHTML = '<tr><td colspan="7" style="text-align:center; padding: 40px;">Nenhuma unidade. Clique em üèóÔ∏è para gerar.</td></tr>';
    return;
  }
  
  tbody.innerHTML = '';
  
  unidades.forEach(u => {
    const tr = document.createElement('tr');
    tr.innerHTML = `
      <td><strong>${u.bloco_nome}</strong></td>
      <td>${u.pavimento}</td>
      <td><strong>${u.numero_unidade}</strong></td>
      <td><span style="padding: 4px 8px; border-radius: 4px; font-size: 12px; ${u.tipo === 'apartamento' ? 'background: #dcfce7; color: #166534;' : 'background: #fef3c7; color: #854d0e;'}">${u.tipo}</span></td>
      <td>${u.tipologia || '-'}</td>
      <td>${u.area_total ? u.area_total + ' m¬≤' : '-'}</td>
      <td>
        <button class="btn-small" onclick="editarUnidade(${u.id})" title="Editar">‚úèÔ∏è</button>
        <button class="btn-small" onclick="deletarUnidade(${u.id})" title="Deletar">üóëÔ∏è</button>
      </td>
    `;
    tbody.appendChild(tr);
  });
}

function filtrarUnidades() {
  const busca = document.getElementById('buscaUnidade').value.toLowerCase();
  const blocoFiltro = document.getElementById('filtroBloco').value;
  const tipoFiltro = document.getElementById('filtroTipo').value;
  
  let filtradas = unidadesCache;
  
  if (busca) {
    filtradas = filtradas.filter(u => 
      u.numero_unidade.toLowerCase().includes(busca) ||
      u.bloco_nome.toLowerCase().includes(busca)
    );
  }
  
  if (blocoFiltro) {
    filtradas = filtradas.filter(u => u.bloco_nome === blocoFiltro);
  }
  
  if (tipoFiltro) {
    filtradas = filtradas.filter(u => u.tipo === tipoFiltro);
  }
  
  renderizarTabelaUnidades(filtradas);
  atualizarEstatisticas(filtradas);
}

function fecharModalUnidades() {
  document.getElementById('modalUnidades').style.display = 'none';
  document.getElementById('buscaUnidade').value = '';
  document.getElementById('filtroBloco').value = '';
  document.getElementById('filtroTipo').value = '';
}

// ==================== EXPORTAR EXCEL ====================
function exportarUnidades() {
  console.log('üìä Exportando unidades para Excel...');
  
  let csv = 'Bloco,Pavimento,Unidade,Tipo,Tipologia,√Årea (m¬≤)\n';
  
  unidadesCache.forEach(u => {
    csv += `${u.bloco_nome},${u.pavimento},${u.numero_unidade},${u.tipo},${u.tipologia || ''},${u.area_total || ''}\n`;
  });
  
  const blob = new Blob([csv], { type: 'text/csv;charset=utf-8;' });
  const link = document.createElement('a');
  link.href = URL.createObjectURL(blob);
  link.download = 'unidades_' + new Date().toISOString().split('T')[0] + '.csv';
  link.click();
  
  console.log('‚úÖ Exportado!');
}

// ==================== EDITAR/DELETAR UNIDADE ====================
async function editarUnidade(id) {
  const tipologia = prompt('Digite a tipologia (ex: 2 Quartos, 3 Quartos):');
  const area = prompt('Digite a √°rea total em m¬≤:');
  
  if (tipologia === null && area === null) return;
  
  try {
    // TODO: Implementar rota PUT /api/unidades/:id no backend
    alert('Funcionalidade em desenvolvimento. Por enquanto, delete e gere novamente.');
  } catch (error) {
    alert('Erro ao editar unidade');
  }
}

async function deletarUnidade(id) {
  if (!confirm('Deletar esta unidade?')) return;
  
  try {
    // TODO: Implementar rota DELETE /api/unidades/:id no backend
    alert('Funcionalidade em desenvolvimento.');
  } catch (error) {
    alert('Erro ao deletar unidade');
  }
}

// ==================== OUTRAS FUN√á√ïES ====================
async function gerarUnidades(empId) {
  if (!confirm('Gerar unidades automaticamente?')) return;
  try {
    const response = await fetch('/api/unidades/criar-automatico', {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify({ empreendimento_id: empId })
    });
    const result = await response.json();
    if (response.ok) {
      alert('‚úÖ ' + result.message);
      carregarEmpreendimentos();
    } else {
      alert('‚ùå Erro: ' + result.error);
    }
  } catch (error) {
    alert('‚ùå Erro');
  }
}

async function deletarEmpreendimento(id) {
  if (!confirm('Deletar este empreendimento e TODAS as suas unidades?')) return;
  try {
    const response = await fetch('/api/empreendimentos/' + id, { method: 'DELETE' });
    if (response.ok) {
      alert('‚úÖ Deletado!');
      carregarEmpreendimentos();
    } else {
      const result = await response.json();
      alert('‚ùå Erro: ' + result.error);
    }
  } catch (error) {
    alert('‚ùå Erro');
  }
}

// ==================== INICIALIZAR ====================
window.addEventListener('DOMContentLoaded', () => {
  console.log('‚úÖ DOM pronto - v4.0');
  carregarEmpreendimentos();
});
</script>

</body>
</html>
