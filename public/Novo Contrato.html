<!DOCTYPE html>
<html lang="pt-BR">
<head>
  <meta charset="UTF-8" />
  <title>Novo Contrato - ContratosVR</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <link rel="stylesheet" href="/styles.css" />
</head>
<body>

  <div class="top-menu">
    <a class="ativo" href="/index.html">Contratos</a>
    <a href="/empreendimentos.html">Empreendimentos</a>
    <a href="/distribuicao.html">Distribui√ß√£o</a>
    <a href="/execucao.html">Execu√ß√£o</a>
    
    <div style="margin-left: auto;">
      <span style="margin-right: 16px; color: #64748b;">üèóÔ∏è ContratosVR</span>
    </div>
  </div>

  <div class="container" style="max-width: 800px;">
    
    <div style="margin-bottom: 24px;">
      <h1 style="margin: 0;">üìã Novo Contrato</h1>
      <p style="color: #64748b; margin-top: 8px;">Cadastre um novo contrato de servi√ßos</p>
    </div>

    <form id="formContrato" onsubmit="salvarContrato(event)" style="background: white; padding: 32px; border-radius: 16px; box-shadow: 0 2px 8px rgba(0,0,0,0.1);">
      
      <!-- Dados B√°sicos -->
      <h3 style="margin-top: 0; color: #667eea;">1. Dados B√°sicos</h3>
      
      <div style="margin-bottom: 20px;">
        <label style="display: block; margin-bottom: 8px; font-weight: 500;">
          N√∫mero do Contrato (OERP) *
        </label>
        <input type="text" id="numero_contrato_oerp" required style="width: 100%; padding: 12px; border: 2px solid #e2e8f0; border-radius: 8px;" placeholder="Ex: CT-2025-001">
      </div>

      <div style="margin-bottom: 20px;">
        <label style="display: block; margin-bottom: 8px; font-weight: 500;">
          Empreendimento *
        </label>
        <select id="empreendimento_id" required onchange="selecionarEmpreendimento()" style="width: 100%; padding: 12px; border: 2px solid #e2e8f0; border-radius: 8px;">
          <option value="">Selecione um empreendimento</option>
        </select>
        <small style="color: #64748b;">N√£o encontrou? <a href="/empreendimentos.html">Cadastre aqui</a></small>
      </div>

      <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 16px; margin-bottom: 20px;">
        <div>
          <label style="display: block; margin-bottom: 8px; font-weight: 500;">
            Tipo de Servi√ßo *
          </label>
          <select id="tipo_servico" required style="width: 100%; padding: 12px; border: 2px solid #e2e8f0; border-radius: 8px;">
            <option value="">Selecione</option>
            <option value="piso">Piso</option>
            <option value="azulejo">Azulejo</option>
            <option value="ambos">Piso + Azulejo</option>
          </select>
        </div>

        <div>
          <label style="display: block; margin-bottom: 8px; font-weight: 500;">
            Status *
          </label>
          <select id="status" required style="width: 100%; padding: 12px; border: 2px solid #e2e8f0; border-radius: 8px;">
            <option value="ativo">Ativo</option>
            <option value="pausado">Pausado</option>
            <option value="encerrado">Encerrado</option>
          </select>
        </div>
      </div>

      <!-- Valores -->
      <h3 style="color: #667eea;">2. Valores e Metragem</h3>

      <div style="display: grid; grid-template-columns: 1fr 1fr 1fr; gap: 16px; margin-bottom: 20px;">
        <div>
          <label style="display: block; margin-bottom: 8px; font-weight: 500;">
            Valor Total (R$) *
          </label>
          <input type="number" id="valor_total" required min="0" step="0.01" style="width: 100%; padding: 12px; border: 2px solid #e2e8f0; border-radius: 8px;" placeholder="0.00" onchange="calcularValorM2()">
        </div>

        <div>
          <label style="display: block; margin-bottom: 8px; font-weight: 500;">
            Metragem Total (m¬≤) *
          </label>
          <input type="number" id="metragem_total" required min="0" step="0.01" style="width: 100%; padding: 12px; border: 2px solid #e2e8f0; border-radius: 8px;" placeholder="0.00" onchange="calcularValorM2()">
        </div>

        <div>
          <label style="display: block; margin-bottom: 8px; font-weight: 500;">
            Valor por m¬≤ (R$)
          </label>
          <input type="number" id="valor_por_m2" readonly style="width: 100%; padding: 12px; border: 2px solid #e2e8f0; border-radius: 8px; background: #f8f9fa;">
        </div>
      </div>

      <!-- Metragem por Pavimento -->
      <h3 style="color: #667eea;">3. Metragem por Pavimento</h3>
      
      <div style="background: #f8f9fa; padding: 16px; border-radius: 8px; margin-bottom: 20px;">
        <p style="margin: 0 0 12px 0; color: #64748b;">Informe a metragem total de cada pavimento</p>
        <div id="pavimentosContainer"></div>
      </div>

      <!-- Datas -->
      <h3 style="color: #667eea;">4. Datas (Opcional)</h3>

      <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 16px; margin-bottom: 20px;">
        <div>
          <label style="display: block; margin-bottom: 8px; font-weight: 500;">
            Data de In√≠cio
          </label>
          <input type="date" id="data_inicio" style="width: 100%; padding: 12px; border: 2px solid #e2e8f0; border-radius: 8px;">
        </div>

        <div>
          <label style="display: block; margin-bottom: 8px; font-weight: 500;">
            Previs√£o de T√©rmino
          </label>
          <input type="date" id="data_previsao_termino" style="width: 100%; padding: 12px; border: 2px solid #e2e8f0; border-radius: 8px;">
        </div>
      </div>

      <!-- Observa√ß√µes -->
      <div style="margin-bottom: 24px;">
        <label style="display: block; margin-bottom: 8px; font-weight: 500;">
          Observa√ß√µes
        </label>
        <textarea id="observacoes" rows="3" style="width: 100%; padding: 12px; border: 2px solid #e2e8f0; border-radius: 8px;" placeholder="Informa√ß√µes adicionais..."></textarea>
      </div>

      <!-- Bot√µes -->
      <div style="display: flex; gap: 12px;">
        <button type="submit" class="btn-primary" style="flex: 1;">‚úì Salvar Contrato</button>
        <button type="button" class="btn-secondary" onclick="window.location.href='/index.html'" style="flex: 1;">Cancelar</button>
      </div>

    </form>

  </div>

  <script>
    let empreendimentos = [];
    let empreendimentoSelecionado = null;

    // ==================== CARREGAR EMPREENDIMENTOS ====================
    async function carregarEmpreendimentos() {
      try {
        const response = await fetch('/api/empreendimentos');
        empreendimentos = await response.json();
        
        const select = document.getElementById('empreendimento_id');
        select.innerHTML = '<option value="">Selecione um empreendimento</option>';
        
        empreendimentos.forEach(emp => {
          const option = document.createElement('option');
          option.value = emp.id;
          option.textContent = emp.nome;
          select.appendChild(option);
        });
      } catch (error) {
        console.error('Erro ao carregar empreendimentos:', error);
        alert('Erro ao carregar empreendimentos. Verifique se h√° empreendimentos cadastrados.');
      }
    }

    // ==================== SELECIONAR EMPREENDIMENTO ====================
    function selecionarEmpreendimento() {
      const id = document.getElementById('empreendimento_id').value;
      if (!id) {
        empreendimentoSelecionado = null;
        document.getElementById('pavimentosContainer').innerHTML = '';
        return;
      }
      
      empreendimentoSelecionado = empreendimentos.find(e => e.id == id);
      gerarCamposPavimentos();
    }

    // ==================== GERAR CAMPOS DE PAVIMENTOS ====================
    function gerarCamposPavimentos() {
      if (!empreendimentoSelecionado) return;
      
      const container = document.getElementById('pavimentosContainer');
      container.innerHTML = '';
      
      const totalPavimentos = empreendimentoSelecionado.quantidade_pavimentos_por_bloco;
      
      for (let p = 1; p <= totalPavimentos; p++) {
        const div = document.createElement('div');
        div.style.cssText = 'display: flex; gap: 12px; align-items: center; margin-bottom: 12px;';
        div.innerHTML = `
          <label style="min-width: 120px; font-weight: 500;">Pavimento ${p}:</label>
          <input 
            type="number" 
            id="pav_${p}" 
            step="0.01" 
            min="0"
            required
            style="flex: 1; padding: 8px 12px; border: 2px solid #e2e8f0; border-radius: 8px;" 
            placeholder="0.00 m¬≤"
            onchange="calcularMetragemTotal()"
          >
        `;
        container.appendChild(div);
      }
      
      // Bot√£o de distribuir igualmente
      const btnDiv = document.createElement('div');
      btnDiv.style.cssText = 'margin-top: 12px;';
      btnDiv.innerHTML = `
        <button type="button" class="btn-secondary" onclick="distribuirIgualmente()" style="width: 100%;">
          üìè Distribuir Igualmente
        </button>
      `;
      container.appendChild(btnDiv);
    }

    // ==================== DISTRIBUIR METRAGEM IGUALMENTE ====================
    function distribuirIgualmente() {
      const metragemTotal = parseFloat(document.getElementById('metragem_total').value);
      if (!metragemTotal || !empreendimentoSelecionado) {
        alert('Informe a metragem total primeiro');
        return;
      }
      
      const totalPavimentos = empreendimentoSelecionado.quantidade_pavimentos_por_bloco;
      const metragen_por_pav = (metragem_total / totalPavimentos).toFixed(2);
      
      for (let p = 1; p <= totalPavimentos; p++) {
        document.getElementById('pav_' + p).value = metragen_por_pav;
      }
    }

    // ==================== CALCULAR VALOR POR M¬≤ ====================
    function calcularValorM2() {
      const valorTotal = parseFloat(document.getElementById('valor_total').value) || 0;
      const metragemTotal = parseFloat(document.getElementById('metragem_total').value) || 0;
      
      if (metragemTotal > 0) {
        const valorM2 = (valorTotal / metragemTotal).toFixed(2);
        document.getElementById('valor_por_m2').value = valorM2;
      }
    }

    // ==================== CALCULAR METRAGEM TOTAL ====================
    function calcularMetragemTotal() {
      if (!empreendimentoSelecionado) return;
      
      let soma = 0;
      const totalPavimentos = empreendimentoSelecionado.quantidade_pavimentos_por_bloco;
      
      for (let p = 1; p <= totalPavimentos; p++) {
        const valor = parseFloat(document.getElementById('pav_' + p).value) || 0;
        soma += valor;
      }
      
      document.getElementById('metragem_total').value = soma.toFixed(2);
      calcularValorM2();
    }

    // ==================== SALVAR CONTRATO ====================
    async function salvarContrato(event) {
      event.preventDefault();
      
      if (!empreendimentoSelecionado) {
        alert('Selecione um empreendimento');
        return;
      }
      
      // Coletar metragem por pavimento
      const metragem_por_pavimento = {};
      const totalPavimentos = empreendimentoSelecionado.quantidade_pavimentos_por_bloco;
      
      for (let p = 1; p <= totalPavimentos; p++) {
        metragem_por_pavimento[p] = parseFloat(document.getElementById('pav_' + p).value) || 0;
      }
      
      const dados = {
        numero_contrato_oerp: document.getElementById('numero_contrato_oerp').value,
        empreendimento_id: parseInt(document.getElementById('empreendimento_id').value),
        tipo_servico: document.getElementById('tipo_servico').value,
        valor_total: parseFloat(document.getElementById('valor_total').value),
        valor_por_m2: parseFloat(document.getElementById('valor_por_m2').value) || 0,
        metragem_total: parseFloat(document.getElementById('metragem_total').value),
        metragem_por_pavimento: metragem_por_pavimento,
        observacoes: document.getElementById('observacoes').value,
        status: document.getElementById('status').value,
        data_inicio: document.getElementById('data_inicio').value || null,
        data_previsao_termino: document.getElementById('data_previsao_termino').value || null
      };
      
      try {
        const response = await fetch('/api/contratos', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify(dados)
        });
        
        const result = await response.json();
        
        if (response.ok) {
          alert('Contrato criado com sucesso!');
          window.location.href = '/index.html';
        } else {
          alert('Erro: ' + result.error);
        }
      } catch (error) {
        console.error('Erro:', error);
        alert('Erro ao salvar contrato');
      }
    }

    // ==================== INICIALIZAR ====================
    document.addEventListener('DOMContentLoaded', () => {
      carregarEmpreendimentos();
    });
  </script>

</body>
</html>
